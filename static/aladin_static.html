.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aladin Catalog Viewer</title>
    <script src="https://aladin.u-strasbg.fr/AladinLite/api/v3/latest/aladin.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #container {
            display: flex;
            height: 100%;
        }
        #aladin-container {
            flex: 1;
            position: relative;
        }
        #controls {
            width: 300px;
            padding: 15px;
            background: #f5f5f5;
            border-left: 1px solid #ddd;
            overflow-y: auto;
        }
        #aladin-lite-div {
            width: 100%;
            height: 100%;
        }
        h1 {
            font-size: 1.5em;
            margin-top: 0;
        }
        .control-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        input, button, select {
            margin: 5px 0;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #45a049;
        }
        #status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        #log {
            height: 150px;
            overflow-y: auto;
            background: #333;
            color: #f0f0f0;
            padding: 8px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        #source-info {
            background: #e9f7fe;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        #loading {
            display: none;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="aladin-container">
            <div id="aladin-lite-div"></div>
        </div>
        <div id="controls">
            <h1>Aladin Catalog Viewer</h1>
            
            <div class="control-group">
                <h3>Upload Catalog</h3>
                <input type="file" id="csvFile" accept=".csv">
                <div>
                    <label for="raColumn">RA Column Name:</label>
                    <input type="text" id="raColumn" value="ra" placeholder="e.g., ra">
                </div>
                <div>
                    <label for="decColumn">DEC Column Name:</label>
                    <input type="text" id="decColumn" value="dec" placeholder="e.g., dec">
                </div>
                <div>
                    <label for="colorColumn">Color by Column (optional):</label>
                    <input type="text" id="colorColumn" placeholder="e.g., magnitude">
                </div>
                <div>
                    <label for="markerSize">Marker Size:</label>
                    <input type="number" id="markerSize" min="1" max="20" value="8">
                </div>
                <div>
                    <label for="initCoords">Initial Coordinates:</label>
                    <input type="text" id="initCoords" placeholder="e.g., 83.633083 22.0145">
                </div>
                <button id="loadBtn" onclick="processCatalogFile()">Load Catalog <span id="loading">Loading...</span></button>
            </div>
            
            <div id="status"></div>
            <div id="source-info"></div>
            
            <div class="control-group">
                <h3>Log</h3>
                <div id="log"></div>
            </div>
        </div>
    </div>

    <script>
        let aladin = null;
        let currentCatalog = null;
        let csvData = null;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const raParam = urlParams.get('ra');
        const decParam = urlParams.get('dec');

        // Initialize the page
        window.onload = function() {
            log("Page loaded. Initializing application...");
            
            // If we have RA/DEC parameters, set them as initial coordinates
            if (raParam && decParam) {
                document.getElementById('initCoords').value = `${raParam} ${decParam}`;
            }
            
            // Load Aladin
            initAladin().then(() => {
                log("Upload a CSV file and click 'Load Catalog' to begin.");
            }).catch(error => {
                log(`Failed to initialize Aladin: ${error.message}`);
            });
        };

        // Wait for Aladin to be loaded completely
        function initAladin() {
            return new Promise((resolve, reject) => {
                // Check if Aladin is already loaded
                if (window.A) {
                    log("Aladin library is already loaded");
                    createAladinInstance();
                    resolve();
                    return;
                }
                
                log("Attempting to load Aladin library...");
                
                // Try multiple CDN sources sequentially
                const cdnSources = [
                    'https://aladin.u-strasbg.fr/AladinLite/api/v3/latest/aladin.js'
                ];
                
                let currentSourceIndex = 0;
                let aladinLoaded = false;
                let globalTimeoutId = null;
                
                function tryLoadScript() {
                    if (aladinLoaded) return; // Skip if already loaded
                    
                    if (currentSourceIndex >= cdnSources.length) {
                        // We've tried all sources, offer local file option and fail
                        const errorMsg = "Failed to load Aladin library from all CDN sources.";
                        showStatus(errorMsg + " Try downloading the library and using it locally.", "error");
                        log("Download Aladin from: https://aladin.u-strasbg.fr/AladinLite/");
                        reject(new Error(errorMsg));
                        return;
                    }
                    
                    const source = cdnSources[currentSourceIndex];
                    log(`Trying to load Aladin from source ${currentSourceIndex + 1}/${cdnSources.length}: ${source}`);
                    
                    const script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = source;
                    
                    // Set a shorter timeout per source attempt
                    const sourceTimeout = setTimeout(() => {
                        log(`Source ${currentSourceIndex + 1} timed out after 7 seconds, trying next source...`);
                        currentSourceIndex++;
                        tryLoadScript();
                    }, 7000);
                    
                    script.onload = function() {
                        clearTimeout(sourceTimeout);
                        log(`Script loaded from ${source}, checking for Aladin object...`);
                        
                        // Give a little time for the script to initialize
                        setTimeout(() => {
                            if (window.A) {
                                aladinLoaded = true;
                                if (globalTimeoutId) clearTimeout(globalTimeoutId);
                                log("Aladin library loaded and detected");
                                createAladinInstance();
                                resolve();
                            } else {
                                log("Script loaded but Aladin object not found, trying next source");
                                currentSourceIndex++;
                                tryLoadScript();
                            }
                        }, 500);
                    };
                    
                    script.onerror = function() {
                        clearTimeout(sourceTimeout);
                        log(`Error loading from source ${currentSourceIndex + 1}, trying next...`);
                        currentSourceIndex++;
                        tryLoadScript();
                    };
                    
                    document.head.appendChild(script);
                }
                
                // Start trying to load scripts
                tryLoadScript();
                
                // Overall timeout as a last resort
                globalTimeoutId = setTimeout(() => {
                    if (!aladinLoaded) {
                        const errorMsg = "Failed to load Aladin library after multiple attempts.";
                        showStatus(errorMsg, "error");
                        log("Detailed troubleshooting: Ensure no content blockers are active and try opening the Aladin CDN URL directly in a new tab.");
                        reject(new Error(errorMsg));
                    }
                }, 20000);
            });
        }

        // Create and configure the Aladin instance
        function createAladinInstance() {
            log("Creating Aladin instance...");
            try {
                // Create Aladin Lite instance
                aladin = A.aladin('#aladin-lite-div', {
                    survey: "P/DSS2/color",
                    fov: 1.0,
                    target: document.getElementById('initCoords').value || "0 0",
                    showReticle: true,
                    showFrame: true,
                    showCatalog: true,
                    fullScreen: false
                });
                
                // Set up click handler
                aladin.on('objectClicked', function(object) {
                    if (object && object.data) {
                        displaySourceInfo(object.data);
                    }
                });
                
                log("Aladin instance created successfully");
            } catch (error) {
                log(`Error creating Aladin instance: ${error.message}`);
                showStatus("Failed to create Aladin map. Please check the console for errors.", "error");
                throw error;
            }
        }

        // Function to handle CSV upload and processing
        function processCatalogFile() {
            try {
                // Show immediate loading feedback when button is clicked
                document.getElementById('loading').style.display = 'inline';
                document.getElementById('loading').textContent = "Processing...";
                showStatus("Processing your request...", "success");
                
                if (!aladin) {
                    showStatus("Aladin is not initialized. Please wait or refresh the page.", "error");
                    document.getElementById('loading').style.display = 'none';
                    return;
                }
                
                // Check if PapaParse is loaded
                if (typeof Papa === 'undefined') {
                    showStatus("CSV parser library not loaded. Loading it now...", "warning");
                    
                    // Show loading indicator to provide feedback
                    document.getElementById('loading').style.display = 'inline';
                    document.getElementById('loading').textContent = "Loading CSV parser...";
                    
                    // Try to load PapaParse dynamically
                    const script = document.createElement('script');
                    script.src = "https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js";
                    script.onload = function() {
                        document.getElementById('loading').style.display = 'none';
                        showStatus("CSV parser loaded successfully. Please try again.", "success");
                    };
                    script.onerror = function() {
                        document.getElementById('loading').style.display = 'none';
                        showStatus("Failed to load CSV parser. Please refresh the page.", "error");
                    };
                    document.head.appendChild(script);
                    
                    return;
                }
                
                const fileInput = document.getElementById('csvFile');
                const raColumnName = document.getElementById('raColumn').value.trim();
                const decColumnName = document.getElementById('decColumn').value.trim();
                const colorColumnName = document.getElementById('colorColumn').value.trim();
                const markerSize = parseInt(document.getElementById('markerSize').value) || 6;
                const initCoords = document.getElementById('initCoords').value.trim();
                
                // Update target coordinates if provided
                if (initCoords) {
                    try {
                        aladin.gotoObject(initCoords);
                        log(`Set view to coordinates: ${initCoords}`);
                    } catch (error) {
                        log(`Error setting coordinates: ${error.message}`);
                        showStatus(`Invalid coordinates format: ${initCoords}`, "error");
                        // Continue processing even if coordinates setting fails
                    }
                }
                
                // Check if file is selected
                if (!fileInput.files.length) {
                    showStatus("Please select a CSV file.", "error");
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                const file = fileInput.files[0];
                log(`Processing file: ${file.name} (${Math.round(file.size / 1024)} KB)`);
                
                // Clear previous catalog
                if (currentCatalog) {
                    try {
                        aladin.removeCatalog(currentCatalog);
                        log("Removed previous catalog");
                    } catch (err) {
                        log(`Warning: Could not remove previous catalog: ${err.message}`);
                        // Continue anyway
                    }
                }
                
                // Create a new catalog
                try {
                    currentCatalog = A.catalog({
                        name: file.name,
                        sourceSize: markerSize
                    });
                    aladin.addCatalog(currentCatalog);
                    log(`Created new catalog with name: ${file.name}`);
                } catch (error) {
                    showStatus(`Error creating catalog: ${error.message}`, "error");
                    document.getElementById('loading').style.display = 'none';
                    return;
                }
                
                // Parse CSV file
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            // Hide loading indicator
                            document.getElementById('loading').style.display = 'none';
                            
                            if (results.errors && results.errors.length > 0) {
                                showStatus("Error parsing CSV: " + results.errors[0].message, "error");
                                log(`CSV parsing errors: ${JSON.stringify(results.errors)}`);
                                return;
                            }
                            
                            if (!results.data || !Array.isArray(results.data)) {
                                showStatus("Invalid CSV format or empty file", "error");
                                return;
                            }
                            
                            csvData = results.data;
                            log(`CSV parsed successfully. Found ${csvData.length} rows`);
                            if (results.meta && results.meta.fields) {
                                log(`Columns found: ${results.meta.fields.join(', ')}`);
                            }
                            
                            // Log first row for debugging
                            if (csvData.length > 0) {
                                log(`First row data: ${JSON.stringify(csvData[0])}`);
                            } else {
                                showStatus("The CSV file contains no data rows.", "error");
                                return;
                            }
                            
                            // Try to find columns case-insensitively if exact match fails
                            let actualRaColumn = raColumnName;
                            let actualDecColumn = decColumnName;
                            
                            if (!csvData[0].hasOwnProperty(raColumnName)) {
                                // Try case-insensitive match
                                const columns = Object.keys(csvData[0]);
                                const raMatch = columns.find(col => col.toLowerCase() === raColumnName.toLowerCase());
                                if (raMatch) {
                                    actualRaColumn = raMatch;
                                    log(`Using column "${raMatch}" for RA (case-insensitive match for "${raColumnName}")`);
                                } else {
                                    showStatus(`Could not find column for RA. Available columns: ${columns.join(', ')}`, "error");
                                    return;
                                }
                            }
                            
                            if (!csvData[0].hasOwnProperty(decColumnName)) {
                                // Try case-insensitive match
                                const columns = Object.keys(csvData[0]);
                                const decMatch = columns.find(col => col.toLowerCase() === decColumnName.toLowerCase());
                                if (decMatch) {
                                    actualDecColumn = decMatch;
                                    log(`Using column "${decMatch}" for DEC (case-insensitive match for "${decColumnName}")`);
                                } else {
                                    showStatus(`Could not find column for DEC. Available columns: ${columns.join(', ')}`, "error");
                                    return;
                                }
                            }

                            // Process sources
                            processSourceData(csvData, actualRaColumn, actualDecColumn, colorColumnName);
                            
                        } catch (error) {
                            // Make sure loading indicator is hidden even if there's an error
                            document.getElementById('loading').style.display = 'none';
                            showStatus(`Error processing CSV data: ${error.message}`, "error");
                            console.error("CSV processing error:", error);
                        }
                    },
                    error: function(error) {
                        document.getElementById('loading').style.display = 'none';
                        showStatus("Error reading file: " + error.message, "error");
                        log(`CSV parsing error: ${error.message}`);
                    }
                });
            } catch (error) {
                // Catch any other errors
                document.getElementById('loading').style.display = 'none';
                showStatus(`Unexpected error: ${error.message}`, "error");
                console.error("Unexpected error in processCatalogFile:", error);
            }
        }

        // Helper function to process source data and add to catalog
        function processSourceData(csvData, raColumnName, decColumnName, colorColumnName) {
            try {
                // Calculate min/max for color column if specified
                let minVal = Infinity;
                let maxVal = -Infinity;
                
                // First pass for min/max calculation
                if (colorColumnName && colorColumnName.trim() !== '') {
                    let colorColumnFound = false;
                    
                    csvData.forEach(row => {
                        if (row.hasOwnProperty(colorColumnName)) {
                            colorColumnFound = true;
                            const val = row[colorColumnName];
                            if (typeof val === 'number' && !isNaN(val)) {
                                minVal = Math.min(minVal, val);
                                maxVal = Math.max(maxVal, val);
                            }
                        }
                    });
                    
                    if (colorColumnFound) {
                        log(`Color column "${colorColumnName}" range: ${minVal} to ${maxVal}`);
                    } else {
                        log(`Warning: Color column "${colorColumnName}" not found in data`);
                    }
                }
                
                // Second pass to add sources
                let sourcesAdded = 0;
                let sourcesSkipped = 0;
                
                csvData.forEach((row, index) => {
                    const ra = row[raColumnName];
                    const dec = row[decColumnName];
                    
                    if (ra === undefined || dec === undefined || ra === null || dec === null || isNaN(ra) || isNaN(dec)) {
                        sourcesSkipped++;
                        if (index < 5) {
                            log(`Skipping row ${index + 1} due to invalid coordinates: RA=${ra}, DEC=${dec}`);
                        }
                        return; // Skip rows with missing coordinates
                    }
                    
                    let color = "#1AB7EA"; // Default color
                    
                    // Color by specified column if available
                    if (colorColumnName && row.hasOwnProperty(colorColumnName) && 
                        typeof row[colorColumnName] === 'number' && !isNaN(row[colorColumnName])) {
                        const val = row[colorColumnName];
                        const normalizedVal = (val - minVal) / (maxVal - minVal || 1); // Avoid division by zero
                        
                        // Create a color gradient from blue to red
                        const r = Math.floor(normalizedVal * 255);
                        const b = Math.floor((1 - normalizedVal) * 255);
                        color = `rgb(${r}, 100, ${b})`;
                    }
                    
                    try {
                        // Add the source to the catalog
                        currentCatalog.addSources([A.source(ra, dec, {
                            color: color,
                            data: row
                        })]);
                        
                        sourcesAdded++;
                        
                        // Log first few sources for debugging
                        if (sourcesAdded <= 3) {
                            log(`Added source ${sourcesAdded}: RA=${ra}, DEC=${dec}`);
                        }
                    } catch (error) {
                        sourcesSkipped++;
                        if (index < 5) {
                            log(`Error adding source at row ${index + 1}: ${error.message}`);
                        }
                    }
                });
                
                // Show stats
                log(`Added ${sourcesAdded} sources, skipped ${sourcesSkipped} invalid entries`);
                
                if (sourcesAdded > 0) {
                    showStatus(`Successfully loaded ${sourcesAdded} sources from catalog${sourcesSkipped ? ` (${sourcesSkipped} entries skipped)` : ''}`, "success");
                    
                    // Center on first valid source
                    try {
                        centerOnFirstSource(csvData, raColumnName, decColumnName);
                    } catch (err) {
                        log(`Warning: Could not center view: ${err.message}`);
                    }
                    
                    // Use Aladin's listener system for click events
                    if (!aladin.hasClickHandler) {
                        aladin.hasClickHandler = true; // Flag to prevent multiple listeners
                        aladin.on('objectClicked', function(object) {
                            if (object && object.data) {
                                displaySourceInfo(object.data);
                                log(`Object clicked: ${object.ra.toFixed(6)}, ${object.dec.toFixed(6)}`);
                            }
                        });
                        log("Click handler attached to Aladin instance");
                    }
                } else {
                    showStatus("No valid sources found in the CSV file. Check column names and data format.", "error");
                }
            } catch (error) {
                showStatus(`Error processing source data: ${error.message}`, "error");
                console.error("Error in processSourceData:", error);
            }
        }

        // Helper to center on first valid source
        function centerOnFirstSource(csvData, raColumnName, decColumnName) {
            if (csvData.length > 0) {
                const firstValidSource = csvData.find(row => {
                    const ra = row[raColumnName];
                    const dec = row[decColumnName];
                    return ra !== undefined && dec !== undefined && ra !== null && dec !== null && !isNaN(ra) && !isNaN(dec);
                });
                
                if (firstValidSource) {
                    const ra = firstValidSource[raColumnName];
                    const dec = firstValidSource[decColumnName];
                    aladin.gotoRaDec(ra, dec);
                    log(`Centered view on first source: RA=${ra}, DEC=${dec}`);
                }
            }
        }

        // Display information about the selected source
        function displaySourceInfo(sourceData) {
            const infoDiv = document.getElementById('source-info');
            infoDiv.style.display = 'block';
            
            let infoHTML = '<h3>Source Information</h3><table style="width:100%">';
            for (const key in sourceData) {
                if (sourceData.hasOwnProperty(key)) {
                    infoHTML += `<tr>
                        <td style="font-weight:bold;padding:2px 5px;border-bottom:1px solid #ddd">${key}</td>
                        <td style="padding:2px 5px;border-bottom:1px solid #ddd">${sourceData[key]}</td>
                    </tr>`;
                }
            }
            infoHTML += '</table>';
            infoDiv.innerHTML = infoHTML;
        }

        // Show status messages
        function showStatus(message, type = "info") {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = type;
        }

        // Log messages
        function log(message) {
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: true });
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
    </script>
    
    <!-- Add PapaParse directly in the HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
</body>
</html>